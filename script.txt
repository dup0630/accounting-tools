Option Explicit

' FILE PATHS
Const WORKDAY_PATH As String = Sheets("Settings").Range(B5).Value
Const DOCSTAR_PATH As String = Sheets("Settings").Range(B8).Value
Const DOCSTARBROGAN_PATH As String = Sheets("Settings").Range(B11).Value

' FILE NAMES
Const WORKDAY_NAME As String = Sheets("Settings").Range(B4).Value
Const DOCSTAR_NAME As String = Sheets("Settings").Range(B7).Value
Const DOCSTARBROGAN_NAME As String = Sheets("Settings").Range(B10).Value

' CUSTOM TEMPLATE COLUMN NAMES
Const INV_NUMBER As String = "Doc number"
Const PO_NUMBER As String = "PO number"
Const INV_DATE As String = "Date"
Const WD_STATUS As String = "Workday status"
Const DOCSTAR_WFS As String = "Docstar Workflow Step"
Const AMOUNT_MATCH As String = "Amount match (Y/N)"
Const NOTES As String = "Notes"



Sub ImportDocstarGuillevin()
    ActiveWorkbook.Queries.Add Name:="DCSTR", Formula:= _
        "let" & _
        "    Source = Csv.Document(File.Contents(""" & DOCSTAR & """), [Delimiter="","", Columns=15, Encoding=1252, QuoteStyle=QuoteStyle.None])," & _
        "    #""Promoted Headers"" = Table.PromoteHeaders(Source, [PromoteAllScalars=true])," & _
        "    #""Changed Type"" = Table.TransformColumnTypes(#""Promoted Headers"", { " & _
        "        {""Document Link"", type text}, " & _
        "        {""VendorName"", type text}, " & _
        "        {""Title"", type text}, " & _
        "        {""VendorID"", Int64.Type}, " & _
        "        {""InvoiceNum"", type text}, " & _
        "        {""InvoiceDate"", type date}, " & _
        "        {""InvoiceAmt"", Currency.Type}, " & _
        "        {""PONum"", type text}, " & _
        "        {""Branch"", type text}, " & _
        "        {""Workflow Step"", type text}, " & _
        "        {""VoucherNumber"", Int64.Type}, " & _
        "        {""Modified On"", type datetime}, " & _
        "        {""Created On"", type datetime}, " & _
        "        {""Annotation Text"", type text}, " & _
        "        {""Workflow Name"", type text} " & _
        "    })" & _
        "in" & _
        "    #""Changed Type"""
    With ActiveSheet.ListObjects.Add(SourceType:=0, Source:= _
        "OLEDB;Provider=Microsoft.Mashup.OleDb.1;Data Source=$Workbook$;Location=DCSTR;Extended Properties=""""" _
        , Destination:=Range("$A$1")).QueryTable
        .CommandType = xlCmdSql
        .CommandText = Array("SELECT * FROM [DCSTR]")
        .RowNumbers = False
        .FillAdjacentFormulas = False
        .PreserveFormatting = True
        .RefreshOnFileOpen = False
        .BackgroundQuery = True
        .RefreshStyle = xlInsertDeleteCells
        .SavePassword = False
        .SaveData = True
        .AdjustColumnWidth = True
        .RefreshPeriod = 0
        .PreserveColumnInfo = True
        .ListObject.DisplayName = "DCSTR"
        .Refresh BackgroundQuery:=False
    End With

    ' DELETE UNNECESSARY COLUMNS (DIFFERENT FOR EACH DATABASE!)
    Columns("A:E").Select
    Selection.Delete Shift:=xlToLeft
    
    ' CHANGE INVOICE NO INTO NUMBER TYPE WITH TEXT TO COLUMNS
    Range("A:A").Select
    Selection.TextToColumns Destination:=Range("A:A"), _
        DataType:=xlDelimited, _
        TextQualifier:=xlDoubleQuote, _
        ConsecutiveDelimiter:=False, _
        Tab:=False, _
        Semicolon:=False, _
        Comma:=False, _
        Space:=False, _
        Other:=False, _
        FieldInfo:=Array(1, 1), _
        TrailingMinusNumbers:=True
    
    Sheets("Table").Select
    
    Range("TABLE[Docstar]").Select
    ActiveCell.FormulaR1C1 = "=VLOOKUP(RC[-5], DCSTR, 5, FALSE)"
    
    Range("TABLE[Amount match]").Select
    ActiveCell.FormulaR1C1 = _
        "=IF(RC[-3]=VLOOKUP(RC[-6], DCSTR,3,FALSE),""Y"",""N"")"
End Sub
Sub ImportWorkday()
    Sheets("Workday").Select
    ActiveWorkbook.Queries.Add Name:="Rechercher des factures fournis", Formula:= _
        "let" & _
        "    Source = Excel.Workbook(File.Contents(""" & WORKDAY & """), null, true)," & _
        "    #""Rechercher des factures fournis1"" = Source{[Name=""Rechercher des factures fournis""]}[Data]," & _
        "    #""Promoted Headers"" = Table.PromoteHeaders(#""Rechercher des factures fournis1"", [PromoteAllScalars=true])," & _
        "    #""Changed Type"" = Table.TransformColumnTypes(#""Promoted Headers"", { " & _
        "{""Facture du fournisseur"", type text}, {""Nº de facture"", type text}, {""Société"", type text}, {""Cost Center ID"", type text}, " & _
        "{""Fournisseur"", type text}, {""Nº de facture du fournisseur"", type text}, {""Note"", Int64.Type}, {""Bons de commande"", type text}, " & _
        "{""Nº de bon de commande externe"", Int64.Type}, {""Date de la facture"", type date}, {""Accounting Date"", type date}, " & _
        "{""Payment Status"", type text}, {""Settlement Number"", type text}, {""Payment Date"", type date}, {""Taxe seulement"", type text}, " & _
        "{""Statut"", type text}, {""Date d'annulation"", type date}, {""Type de facture réglementaire"", type text}, {""Date d'échéance"", type date}, " & _
        "{""Date de remise"", type date}, {""Montant de la facture"", type number}, {""Montant de l'escompte de la facture commerciale"", Int64.Type}, " & _
        "{""Montant brut de la facture commerciale"", type number}, {""Solde dû"", type number}, {""Monnaie"", type text}, {""Intercompany"", type text}, " & _
        "{""Direct Intercompany"", type text}, {""En attente"", type text}, {""Ajustement"", type text}, {""Motif de l'ajustement"", type text}, " & _
        "{""Âge de la facture (en jours)"", Int64.Type}, {""Age des dettes (en jours)"", Int64.Type}, {""Supplier Category"", type text}, " & _
        "{""Invoice Amount in Base Currency"", type number}, {""Facture créée par"", type text}, {""Moment de création"", type datetime} })" & _
        "in" & _
        "    #""Changed Type"""

    With ActiveSheet.ListObjects.Add(SourceType:=0, Source:= _
        "OLEDB;Provider=Microsoft.Mashup.OleDb.1;Data Source=$Workbook$;Location=""Rechercher des factures fournis"";Extended Properties=""""" _
        , Destination:=Range("$A$1")).QueryTable
        .CommandType = xlCmdSql
        .CommandText = Array("SELECT * FROM [Rechercher des factures fournis]")
        .RowNumbers = False
        .FillAdjacentFormulas = False
        .PreserveFormatting = True
        .RefreshOnFileOpen = False
        .BackgroundQuery = True
        .RefreshStyle = xlInsertDeleteCells
        .SavePassword = False
        .SaveData = True
        .AdjustColumnWidth = True
        .RefreshPeriod = 0
        .PreserveColumnInfo = True
        .ListObject.DisplayName = "Rechercher_des_factures_fournis"
        .Refresh BackgroundQuery:=False
    End With

    ' CHANGE TABLE NAME
    ActiveSheet.ListObjects("Rechercher_des_factures_fournis").Name = "WD"
    
    ' DELETE UNNECESSARY COLUMNS (DIFFERENT FOR EACH DATABASE!)
    Columns("A:E").Select
    Selection.Delete Shift:=xlToLeft
    
    ' CHANGE INVOICE NO INTO NUMBER TYPE WITH TEXT TO COLUMNS
    Range("A:A").Select
    Selection.TextToColumns Destination:=Range("A:A"), _
        DataType:=xlDelimited, _
        TextQualifier:=xlDoubleQuote, _
        ConsecutiveDelimiter:=False, _
        Tab:=False, _
        Semicolon:=False, _
        Comma:=False, _
        Space:=False, _
        Other:=False, _
        FieldInfo:=Array(1, 1), _
        TrailingMinusNumbers:=True
    
    Sheets("Table").Select
    Range("TABLE[Workday]").Select
    ActiveCell.FormulaR1C1 = "=VLOOKUP(RC[-4],WD,7,FALSE)"
End Sub
Sub ImportDocstarBrogan()
    ActiveWorkbook.Queries.Add Name:="DCSTRBRGN", Formula:= _
        "let" & _
        "    Source = Csv.Document(File.Contents(""" & DOCSTARBROGAN & """), " & _
        "[Delimiter="","", Columns=15, Encoding=1252, QuoteStyle=QuoteStyle.None])," & _
        "    #""Promoted Headers"" = Table.PromoteHeaders(Source, [PromoteAllScalars=true])," & _
        "    #""Changed Type"" = Table.TransformColumnTypes(#""Promoted Headers"", { " & _
        "{""Document Link"", type text}, " & _
        "{""Title"", type text}, " & _
        "{""VendorName"", type text}, " & _
        "{""VendorID"", Int64.Type}, " & _
        "{""InvoiceNum"", type text}, " & _
        "{""InvoiceDate"", type date}, " & _
        "{""InvoiceAmt"", Currency.Type}, " & _
        "{""PONum"", Int64.Type}, " & _
        "{""Branch"", type text}, " & _
        "{""Workflow Step"", type text}, " & _
        "{""VoucherNumber"", Int64.Type}, " & _
        "{""Created On"", type datetime}, " & _
        "{""Modified On"", type datetime}, " & _
        "{""Annotation Text"", type text}, " & _
        "{""Workflow Name"", type text} })," & _
        "in" & _
        "    #""Changed Type"""
        
    With ActiveSheet.ListObjects.Add(SourceType:=0, Source:= _
        "OLEDB;Provider=Microsoft.Mashup.OleDb.1;Data Source=$Workbook$;Location=DCSTRBRGN;Extended Properties=""""" _
        , Destination:=Range("$A$1")).QueryTable
        .CommandType = xlCmdSql
        .CommandText = Array("SELECT * FROM [DCSTRBRGN]")
        .RowNumbers = False
        .FillAdjacentFormulas = False
        .PreserveFormatting = True
        .RefreshOnFileOpen = False
        .BackgroundQuery = True
        .RefreshStyle = xlInsertDeleteCells
        .SavePassword = False
        .SaveData = True
        .AdjustColumnWidth = True
        .RefreshPeriod = 0
        .PreserveColumnInfo = True
        .ListObject.DisplayName = "DCSTRBRGN"
        .Refresh BackgroundQuery:=False
    End With
    
    ' DELETE UNNECESSARY COLUMNS (DIFFERENT FOR EACH DATABASE!)
    Columns("A:D").Select
    Selection.Delete Shift:=xlToLeft
    
    ' CHANGE INVOICE NO INTO NUMBER TYPE WITH TEXT TO COLUMNS
    Range("A:A").Select
    Selection.TextToColumns Destination:=Range("A:A"), _
        DataType:=xlDelimited, _
        TextQualifier:=xlDoubleQuote, _
        ConsecutiveDelimiter:=False, _
        Tab:=False, _
        Semicolon:=False, _
        Comma:=False, _
        Space:=False, _
        Other:=False, _
        FieldInfo:=Array(1, 1), _
        TrailingMinusNumbers:=True
        
    Sheets("Table").Select
    Range("TABLE[Docstar]").Select
    ActiveCell.FormulaR1C1 = "=VLOOKUP(RC[-5],DCSTRBRGN,6,FALSE)"
    
    Range("TABLE[Amount match]").Select
    ActiveCell.FormulaR1C1 = "=IF(RC[-3]=VLOOKUP(RC[-6],DCSTRBRGN,3,FALSE),""Y"",""N"")"
    Range("G3").Select
End Sub

Sub UseBothDocstars()
    Range()

